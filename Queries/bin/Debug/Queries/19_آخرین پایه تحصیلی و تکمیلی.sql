/*	MaxGRD,MaxGRDT	*/
IF COL_LENGTH('TABLENAME','MaxGRD') IS NULL BEGIN ALTER TABLE [TABLENAME] ADD MaxGRD INT END
IF COL_LENGTH('TABLENAME','MaxGRDT') IS NULL BEGIN ALTER TABLE [TABLENAME] ADD MaxGRDT INT END
GO
IF COL_LENGTH('TABLENAME','MaxGRD') IS NOT NULL BEGIN UPDATE [TABLENAME] SET MaxGRD=NULL END
IF COL_LENGTH('TABLENAME','MaxGRDT') IS NOT NULL BEGIN UPDATE [TABLENAME] SET MaxGRDT=NULL END
UPDATE c SET c.MaxGRD=d.MaxGRD,c.MaxGRDT=d.MaxGRDT FROM [TABLENAME] c
JOIN 
	(	SELECT a.StudentID,a.MaxGRD,CASE WHEN a.MaxGRD-b.MaxGRDT<=2 THEN b.MaxGRDT ELSE 0 END AS  MaxGRDT
		FROM (SELECT StudentID,MAX(Grade)MaxGRD FROM [AmarPartDB].dbo.TBL_Arziabi GROUP BY StudentID)a
		FULL JOIN(SELECT StudentID,MAX(Grade)MaxGRDT FROM [AmarPartDB].dbo.TBL_Arziabi WHERE ArzType='Total' GROUP BY StudentID)b
		ON b.StudentID = a.StudentID
	)d ON d.StudentID = c.StudentID

UPDATE [TABLENAME] SET MaxGRDT=Null WHERE MaxGRD<0
UPDATE [TABLENAME] SET MaxGRDT=Null WHERE MaxGRDT<0



